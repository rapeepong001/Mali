
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏ä‡∏ï‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô AI</title>
  <style>
    body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #fceff9; display: flex; flex-direction: column; height: 100vh; }
    header { background: #ffafcc; padding: 15px; text-align: center; font-size: 1.2em; color: #4b3b86; }
    #bond-status { font-size: 0.9em; color: #6a4c93; margin-top: 5px; }
    #chat-box { flex: 1; overflow-y: auto; padding: 20px; }
    .message { margin: 10px 0; padding: 10px 15px; border-radius: 12px; max-width: 70%; }
    .user { background: #fff; align-self: flex-end; }
    .bot { background: #ffe0f0; align-self: flex-start; }
    #input-area { display: flex; padding: 15px; background: #fff0f5; }
    #input-area input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-right: 10px; }
    #input-area button { padding: 10px 20px; background: #ffafcc; border: none; border-radius: 8px; color: #4b3b86; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>

<header>
  <div id="header">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  <div id="bond-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå...</div>
</header>

<div id="chat-box"></div>
<div id="input-area">
  <input type="text" id="user-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." />
  <button onclick="sendMessage()">‡∏™‡πà‡∏á</button>
</div>

<script>
  let userName = localStorage.getItem("mali_username") || null;

  if (!userName) {
    const nameFromURL = new URLSearchParams(window.location.search).get("user");
    if (nameFromURL) {
      userName = nameFromURL;
      localStorage.setItem("mali_username", userName);
    } else {
      userName = prompt("‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏ô‡πä‡∏≤~ üíñ");
      if (userName) {
        localStorage.setItem("mali_username", userName);
      } else {
        userName = "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô";
      }
    }
  }

  const queryParams = new URLSearchParams(window.location.search);
  const friendName = queryParams.get("friend") || "AI";
  // ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏î‡∏¢ localStorage ‡∏´‡∏£‡∏∑‡∏≠ prompt ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  document.getElementById("header").innerText = "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: " + friendName;

  const PersonaPack = {
    Momo: {
      name: "Momo",
      personality: "‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏ä‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á",
      tone: "‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡∏≠‡πà‡∏≠‡∏ô‡πÇ‡∏¢‡∏ô",
    },
    Hana: {
      name: "Hana",
      personality: "‡∏™‡∏î‡πÉ‡∏™ ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á ‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à",
      tone: "‡∏™‡∏î‡πÉ‡∏™ ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á",
    },
  };

  function getBondLevel(exp) {
    if (exp < 10) return { level: 1, label: "‡∏Ñ‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å" };
    if (exp < 30) return { level: 2, label: "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà" };
    if (exp < 60) return { level: 3, label: "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó" };
    if (exp < 100) return { level: 4, label: "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ó‡πâ" };
    return { level: 5, label: "‡∏Ñ‡∏π‡πà‡πÉ‡∏à üíñ" };
  }

  let bondEXP = 0;
  const chatBox = document.getElementById("chat-box");
  let chatHistory = [];

  function updateBondStatus() {
    const bond = getBondLevel(bondEXP);
    document.getElementById("bond-status").innerText =
      `üåü ‡∏£‡∏∞‡∏î‡∏±‡∏ö: Lv.${bond.level} ‚Äì ${bond.label} (EXP: ${bondEXP})`;
  }

  function addMessage(text, isUser) {
    const msg = document.createElement("div");
    msg.className = "message " + (isUser ? "user" : "bot");
    msg.innerText = text;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function buildHeartPromptWithMemory(characterName, userMessage, userName) {
    const persona = PersonaPack[characterName] || {};
    const memoryLines = chatHistory.slice(-5).map(pair => `‡∏Ñ‡∏∏‡∏ì: ${pair.user}\n${persona.name}: ${pair.bot}`).join("\n");
    return `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ ${persona.name || "AI"}, ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ.
‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å: ${persona.personality}
‡πÇ‡∏ó‡∏ô: ${persona.tone}
‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤:
${memoryLines}
‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏∑‡∏≠: ${userName}\n‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤: "${userMessage}"
‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠
    `.trim();
  }

  async function sendMessage() {
    const input = document.getElementById("user-input");
    const text = input.value.trim();
    if (!text) return;
    addMessage(text, true);
    input.value = "";

    bondEXP += 1; // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° = +1 EXP
    updateBondStatus();

    const prompt = buildHeartPromptWithMemory(friendName, text, userName);

    try {
      const response = await fetch("http://localhost:3000/api/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer YOUR_OPENAI_API_KEY"
        },
        body: JSON.stringify({
          prompt: prompt
        })
      });
      const data = await response.json();
      const reply = data.choices?.[0]?.message?.content || "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡πä‡∏≤ ‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ";
      addMessage(reply, false);
      bondEXP += 1; // AI ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö = +1 EXP
      updateBondStatus();
      chatHistory.push({ user: text, bot: reply });
    } catch (e) {
      addMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI", false);
    }
  }

  updateBondStatus();
</script>

</body>
</html>
